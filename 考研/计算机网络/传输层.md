---
tags:
  - 计算机网络
---
# 传输层提供的服务
## 1. 传输层的功能
- **进程间通信**：传输层为同一主机上不同进程之间提供逻辑通信。
- **复用与分用**：
    - **复用**：将多个应用进程的通信信息合并后交给网络层。
    - **分用**：根据端口号将从网络层收到的数据交给不同的应用进程。
- **差错控制**：传输层通过机制确保数据传输的正确性。
## 2. 传输层寻址与端口
- **端口号**：
    - **功能**：端口号用于标识主机上的应用进程。
    - **范围**：16位端口号，共有65536个端口。
    - **分类**：
	    - **服务端端口**：
	        - **熟知端口**：0-1023
	        - **登记端口**：1024-49151
	    - **客户端端口**：49152-65535
- **套接字（Socket）**：由主机IP地址和端口号唯一标识一个进程。
## 3. 无连接服务与面向连接服务
- **无连接服务**：如UDP，不需要建立连接即可进行数据传输。
- **面向连接服务**：如TCP，需要先建立连接并维护连接状态。
# UDP协议
## 1.UDP 数据报
![Pasted image 20241212232050.png](../../pic/Pasted%20image%2020241212232050.png)
### udp复用和分用
- 复用
	- 发送方把多个应用数据报打包发送
- 分用
	- 接收方把收到的打包数据报拆开分发给各个应用
## 2.UDP 校验
- 伪首部：计算校验和时才出现，不传递
    - 17 表示UDP协议
    - UDP 长度 首部 8B + 数据部分
![Pasted image 20241212232124.png](../../pic/Pasted%20image%2020241212232124.png)
### 校验和计算
#### 二进制反码求和
- 就是加数和被加数都取反然后相加，需要计算进位
- 如果最高位进1就把那个1 拿下来 加到最后面去。
#### 在发送端:
1. 填上伪首部
2. 全0填充检验和字段
3. 全0填充数据部分(UDP数据报要看成许多4B的字串接起来)
4. 伪首部+首部+数据部分采用二进制反码求和
5. 把和求反码填入检验和字段
6. 去掉伪首部，发送
#### 在接收端:
1. 填上伪首部
2. 伪首部+首部+数据部分采用二进制反码求和
3. 结果全为1则无差错，否则丢弃数据报/交给应用层附上出差错的警告
![Pasted image 20241212232157.png](../../pic/Pasted%20image%2020241212232157.png)
# TCP协议
## 1.TCP 段
![Pasted image 20241212232221.png](../../pic/Pasted%20image%2020241212232221.png)
- **序号 (Seq)**：表示发送数据的第一个字节的序号，用于确保数据按顺序传输。
- **确认号 (Ack)**：表示期望收到的下一个数据的序号，确认号为 N 时，表示数据号为 N 前的所有数据已正常接收。
- **数据偏移**：指示数据部分相对于报文段起始部分的位置，单位为4字节。
- **控制位**：
    - **URG**：紧急位，表示报文含有紧急数据，配合紧急指针使用。
    - **ACK**：确认位，表示确认号有效。连接建立后，所有报文段的ACK位应为1。
    - **PSH**：推送位，表示接收方应尽快将数据交给上层。
    - **RST**：复位位，表示连接出错，需重新建立连接。
    - **SYN**：同步位，表示连接请求或接收。
    - **FIN**：终止位，表示数据发送完毕，要求释放连接。
- **窗口 (Window)**：接收方的接收窗口大小，控制允许发送方发送的数据量。
- **检验和 (Checksum)**：用于校验报文段的完整性，计算时包括伪首部。
- **紧急指针**：仅当URG=1时有效，表示报文段中的紧急数据字节数。
- **选项**：
    - **最大报文段长度 (MSS)**：指定TCP报文段最大数据载荷的长度。
    - **窗口扩大选项**：用于扩大接收窗口，提高吞吐率。
    - **时间戳选项**：用于计算往返时间（RTT）并防止序号溢出（PAWS）。
    - **选择确认 (SACK)**：允许接收方选择性确认已接收的非连续数据。
## 2.TCP 连接管理
### 假设发送端A，接受端（服务端）为B
#### 三次握手过程中seq和ack
| 方向   | seq   | ack   | SYN | ACK |
| ---- | ----- | ----- | --- | --- |
| A->B | 10000 | 0     | 1   | 0   |
| B->A | 20000 | 10001 | 1   | 1   |
| A->B | 10001 | 20001 | 0   | 1   |
#### 数据传输过程中seq和ack的值
| 方向   | seq   | ack              | 数据长度 | 数据包长度 |
| ---- | ----- | ---------------- | ---- | ----- |
| A->B | 40000 | 70000            | 1460 | 1518  |
| B->A | 70000 | 40000+1460=41460 | 0    | 64    |
| A->B | 41460 | 70000            | 1460 | 1518  |
| B->A | 70000 | 41460+1460=42920 | 0    | 64    |
##### 注
1. 只有发送了1B有效数据才会使seq+1
2. 在三次握手的时候+1是因为标志位的SYN同步标志占用了1，并且三次握手是没有数据的，所以只加了1。而进行数据传输时标志位都是为0，所以不用+1
3. 以太网1500B-20B IP头-20B TCP头=1460B，18B MAC帧头+尾
#### 四次挥手过程中seq和ack的值
| 方向   | seq   | ack        | FIN    | ACK       |
| ---- | ----- | ---------- | ------ | --------- |
| A->B | 80000 | 90000      | 1      | 1         |
| A状态  | 变为    | FIN-WAIT1  |        |           |
| B->A | 90000 | 80001      | 0      | 1         |
| B状态  | 变为    | CLOSE-WAIT | 发送完    | 剩下的数据     |
| B->A | 90000 | 80001      | 1      | 1         |
| B状态  | 变为    | LAST-ACK   |        |           |
| A->B | 80001 | 90001      | 0      | 1         |
| A状态  | 变为    | TIME-WAIT  | B收到后结束 | A过2MSL后结束 |
注：
1. MSL是报文段在网络上能存活的最大时间
## 3. TCP 可靠传输
- **可靠性**：确保接收方收到的数据与发送方发出的数据完全一致（顺序和内容）。
- **相关机制**：
    - **校验**：通过增加伪首部进行校验。与UDP一致，17改为6
    - **序号**：每个数据包都有序号，确保数据按顺序到达。
    - **确认**：接收方对数据包发送确认。
    - **重传**：若超时未收到确认，则重传数据包。
    - **重传时间（RTO）**：基于往返时间（RTT）计算，重传时间应略大于RTT。
    - **自适应算法**：根据每次测量的RTT计算加权平均，动态调整RTO。
	    - RTO=平均RTT + 4 * （新RTT与旧RTT的偏差）
    - **冗余ACK**：接收方在收到失序报文段时发送冗余确认，指示下一个期望的序号。
## 4. TCP 流量控制
- **控制发送速度**：利用滑动窗口机制调整数据发送速率。
- **接收窗口（rwnd）**：接收方根据缓存大小动态调整，并通过窗口字段告知发送方。
- **发送窗口（swnd）**：由接收窗口rwnd和拥塞窗口cwnd的最小值决定。
## 5. TCP 拥塞控制
- **目的**：防止过多数据注入网络，避免网络拥塞。
- **控制机制**：
    - **慢开始和拥塞避免**：拥塞窗口cwnd的维护原则:只要网络没有出现拥塞，拥塞窗口就再增大一些;但只要网络出现拥塞，拥塞窗口就减少一些。
    - **慢开始**：cwnd值增大。
    - **拥塞避免**：发生超时后，cwnd减小为原来的一半，ssthresh=cwnd
    - **慢开始门限（ssthresh）**：cwnd小于ssthresh时使用慢开始，大于时使用拥塞避免。
- ![Pasted image 20241212230954.png](../../pic/Pasted%20image%2020241212230954.png)
    - **快重传和快恢复**：通过快速识别丢包并重传。
    - **快重传**：接收方收到失序的报文段也要发送重复确认，发送方收到3个重复确认立即开始重传。
    - **快恢复**：==收到3个重复时使用==，发送方将慢开始门限ssthresh值和拥塞窗口cwnd值调整为当前窗口的一半;开始执行拥塞避免算法
- ![Pasted image 20241212231026.png](../../pic/Pasted%20image%2020241212231026.png)
    注：
    - 在TCP的慢启动阶段，拥塞窗口通常在每次收到一个确认（ACK）时增加。
	- 当TCP进入拥塞避免阶段时，拥塞窗口在收到每个确认段时只增加 1MSS/cwnd（cwnd一轮+1）。