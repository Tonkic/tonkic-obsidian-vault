---
tags:
  - 计算机网络
---
# (一)网络层的功能
## 1. **异构网络互连**  
网络层通过不同类型的中继器互连各种异构网络，包括物理层的转发器和集线器、数据链路层的网桥和交换机、网络层的路由器及更高层的网关。
## 2. **路由与转发**
- **转发**：数据包根据目的地址从一个节点转发到下一个节点（数据平面）。
- **路由控制**：决定最佳路径的选择（控制平面）。
## 3. **SDN 基本概念**
- 传统路由器有控制平面和数据平面，SDN将控制平面集中化，数据平面分布式。路由器不再相互交换信息，而是逻辑上的远程控制器（可能由多个服务器组成）通过Openflow协议将转发表（在SDN中被称为流表）下发给路由器
- **北向接口**：SDN的编程接口。
- **南向接口**：控制器与转发设备之间的接口。
- **东西向接口**：SDN控制器之间的接口。
## 4. **拥塞控制**
- **拥塞**：过量数据包导致网络性能下降。
- **控制方式**：
	- **开环控制**：静态预防拥塞。
	- **闭环控制**：动态根据网络状况调整，基于反馈进行拥塞控制。
# (二)路由算法
## 1. **静态路由与动态路由**
- **静态路由**：由管理员手动配置，适用于安全性要求高或规模较小的网络。缺点是更新较慢，不适应网络拓扑或链路的变化。
- **动态路由**：路由器之间自动交换信息，依据网络拓扑和链路状态动态调整路由。适用于大规模网络，能够及时响应网络变化，但算法复杂，可能增加网络负担。
- 默认路由：0.0.0.0/0
## 2. **距离-向量路由算法**
- 路由器仅知道与直接连接的邻居的网络信息，使用“距离”来表示路由的优劣。
- 常见协议：**RIP**
## 3. **链路状态路由算法**
- 路由器掌握完整的网络拓扑信息，包括所有链路的状态和费用，通过算法计算出最佳路径。
- 常见协议：**OSPF**（Open Shortest Path First）
## 4. **层次路由**
- 将大网络划分为多个自治系统（AS）
- AS之间使用BGP协议通信
	- BGP借助TCP实现
	- 触发更新
# (三)IPv4
## 1.IPv4 分组
#### 1. **IPv4数据报格式**
![Pasted image 20241212202118.png](../../pic/Pasted%20image%2020241212202118.png)
IPV4数据报包括**首部**和**数据**两部分。
- **首部固定部分**：20字节，包括关键字段。
- **可选部分**：用于提供错误检测、安全等功能，长度可变。
#### 2. **重要字段含义**
1. **版本**（4位）：表示IP版本，当前为IPv4。
2. **首部长度**（4位）：单位为4字节，最大值15（通常为5(20B)，表示无可选字段）。
3. **总长度**（16位）：IP数据报的总长度（首部+数据），最大65535字节。
4. **标识**（16位）：每个数据报分片共享同一标识，用于重组。
5. **标志**（3位）：
    - **DF (Don't Fragment)**：如果DF=1，禁止分片；DF=0，允许分片。
    - **MF (More Fragment)**：如果MF=1，表示还有更多分片；MF=0，表示这是最后一个分片。
6. **片偏移**（13位）：表示该分片在原数据报中的相对位置，单位为8字节。
   - 所以分片大小都是8B的整数倍
7. **首部校验和**（16位）：仅校验IP数据报的首部。
8. **生存时间TTL**（8位）：数据报在网络中可经过的最大路由器数，防止数据报在网络中无限循环。
9. **协议**（8位）：表示数据部分使用的传输层协议（如TCP、UDP等）。
10. **源地址**（4字节）：发送方IP地址。
11. **目的地址**（4字节）：接收方IP地址。
助记：1总8片首4（一种八片首饰）
#### 3. **IP数据报分片**
- **分片原因**：当数据报大小超过链路层的最大传输单元（MTU）时，需要进行分片。例如，以太网的MTU为1500字节。
- **分片过程**：分片后的数据报每片具有相同的标识，且每片的长度必须是8字节的倍数，最后一个分片可能不是8字节的整数倍。
#### 4. **网络层转发分组流程**
1. 提取数据报的目的IP地址，得出目的网络地址。
2. 如果路由器直接连接到目的网络，则交付数据报。
3. 否则，查找路由表：
    - 如果有到特定主机的路由，转发给下一跳路由器。
    - 如果有到目的网络的路由，转发给下一跳路由器。
    - 如果没有指定路由，则使用默认路由。
4. 若没有匹配路由，报告转发错误。
- 当数据报超过链路层的最大传输单元 (MTU) 时，需要进行分片。分片后的数据报会在目的主机上重新组装。
## 2.IPv4地址与NAT
#### 1. **IPv4地址**
![Pasted image 20241212204213.png](../../pic/Pasted%20image%2020241212204213.png)
A和B中间的127给扣了，作为本地环回地址

| **NetID/网络号** | **HostID主机** | **作为IP分组源地址** | **作为IP分组目的地址** | **用途**                                 |
| ------------- | ------------ | ------------- | -------------- | -------------------------------------- |
| 全0            | 全0           | 可以            | 不可以            | 本网范围内表示主机，路由表中用于表示默认路由(表示整个Internet网络) |
| 全0            | 特定值          | 可以            | 不可以            | 表示本网内某个特定主机                            |
| 全1            | 全1           | 不可以           | 可以             | 本网广播地址（路由器不转发）                         |
| 特定值           | 全0           | 不可以           | 不可以            | 网络地址，表示一个网络                            |
| 特定值           | 全1           | 不可以           | 可以             | 直接广播地址，对特定网络上的所有主机进行广播                 |
| 127           | 任何数(非全0/1)   | 可以            | 可以             | 用于本地软件环回测试，称为环回地址                      |
#### 2. **网络地址转换（NAT）**
- **私有IP地址**：用于局域网，不能直接连接到Internet，需通过NAT转换成公网IP。
- **专用互联网/本地互联网**：使用私有IP的网络称为专用互联网，私有IP地址可在多个局域网中重复使用。
- **NAT工作原理**：NAT路由器通过转换表将本地IP地址映射到公网IP，实现内外网通信。多个私有IP可共享一个公网IP。
	- 内网发到公网：路由器替换LAN口地址（源地址）为WAN口地址（路由器地址）
	- 公网发到内网：使用NAPT，路由器通过端口确定数据报是发给哪一台主机的，如果某个端口已经被使用，顺延+1
## 3.子网划分、路由聚集、子网掩码与 CIDR
### **子网划分**
- **思想：** 将IP地址中的主机号的前几位借用作为子网号。
- **子网掩码：** 用于区分IP地址中的网络号、子网号和主机号。子网掩码通过“与”运算得出子网地址。
- **例子：**
    - IP地址：192.168.5.56
    - 子网掩码：255.255.255.0
    - 结果：子网地址为 192.168.5.0
### **CIDR（无分类域间路由选择）**
- **背景：** 由于A、B、C类地址的划分不够灵活，CIDR应运而生，它允许更灵活地定义网络前缀和主机地址。
- **CIDR表示法：** 使用“网络前缀/子网掩码长度”的方式，例如 `192.168.1.0/24` 表示前24位为网络前缀。
### **路由聚合与最长前缀匹配**
- **路由聚合：** 将多个子网聚合成一个更大的网络，减少路由表的大小。
- **最长前缀匹配：** 路由器根据目的地址选择最具体的路由条目，匹配最长的网络前缀。
## 4.ARP协议、DHCP协议与ICMP协议
1. **ARP协议（地址解析协议）**:
    - **目的**: 通过IP地址到MAC地址的映射，确保数据链路层传输的MAC帧能够准确送达。
    - **工作原理**: 
	    - 首先查找ARP表。
	    - 如果没有匹配的MAC地址，发送广播ARP请求(MAC目的地址全1)
	    - 目的主机回应ARP响应，携带自己的MAC地址。
    - **ARP表**: 存储IP地址与MAC地址的映射，每10-20分钟更新一次。
2. **DHCP协议（动态主机配置协议）**:
	**发现报文**: 客户端广播请求DHCP服务器提供配置。
	**提供报文**: DHCP服务器响应，提供可用的IP地址和配置信息。
	**请求报文**: 客户端选择一个DHCP服务器，并发出请求；即使租用期过期也会重新发送。
	**确认报文**: DHCP服务器确认分配的IP地址及配置，完成过程。
	- 除了确认报文都是广播
1. **ICMP协议（网际控制报文协议）**:
	- **差错报文**: 
		- "终点不可达"
		- "源点抑制"（放慢发送速率）
		- "时间超过"（TTL为0）
		- 参数问题
		- 改变路由（有更好的路由）
	- **询问报文**: 
		- 回送请求和回答报文
			- 测试目的站是否可达
		- 时间戳请求和回答报文
			- 用来主机与路由器同步时钟
		- 地址掩码请求和回答报文
		- 路由器询问和通告报文
	- **不应发送**：
		1. 对于ICMP报文本身的错误，不应再发送差错报告。
		2. 只对IP分片的第一个分片发送错误报告，后续分片不再发送。
		3. 对于多播（组播）地址的差错，不发送报告。
		4. 对于如127.0.0.1或0.0.0.0等特殊地址，不发送差错报文。
# (四)IPv6
### 2. **IPv6 地址**
- **版本**: 协议版本：6。
- **优先级**: 区分数据报的类别和优先级。
- **流标签**: 标识来自同一源到同一目的地的一系列数据报。
- **有效载荷长度**: 包含扩展首部和数据的总长度。
- **下一个首部**: 指示下一个扩展首部或数据部分。
- **跳数限制**: TTL（生存时间）。
![Pasted image 20241212220038.png](../../pic/Pasted%20image%2020241212220038.png)
### **IPv6 地址的表示形式**
- **一般形式**: 冒号十六进制记法。
- **压缩形式**: 连续四个零用一个零表示（:0000:=>:0:）；连续零可以通过双冒号表示（双冒号只能出现一次）。（:0000:0000:=>::）
### **IPv4 与 IPv6 兼容**
- **双栈协议**: 同时启用IPv4和IPv6协议栈。
- **隧道技术**: 将IPv6数据包封装为IPv4数据包进行传输。
### **IPv6 与 IPv4 的区别**
- **地址长度**: IPv6地址为128位，IPv4为32位。
- **可选字段**: IPv6移除可选字段，减少路由器处理时间，路由器不处理扩展首部。
- **即插即用**: IPv6支持即插即用，IPv4需依赖DHCP。
- **数据报长度**: IPv6长度为8B的整数倍，IPv4为4B的整数倍。
- **分片**: IPv6只能由主机进行分片；IPv4由路由器和主机分片，目标主机负责组装。
- **MTU超限**: 如果分组超过MTU，路由器丢弃并通过ICMPv6通知源主机。
# (五)路由协议
## 1.自治系统
## 2.域内路由与域间路由
内部使用RIP（UDP）/OSPF（IP），外部使用BGP（TCP）
- ru oi bt
## 3.RIP 路由协议
- **路由表特点**：维护到每个目的网络的唯一最佳==下一跳地址==与==距离==，最大跳数为15，16表示不可达。
- **信息交换**：仅与相邻路由器交换路由表，每30秒更新一次。
- **收敛**：通过多次交换更新后，所有路由器最终会收敛，知道到达本自治系统所有网络的最短路径和下一跳路由器。
- **优缺点**：好消息传递较快，坏消息传递较慢
## 4.OSPF 路由协议
- 拓扑中的每台路由器都在整个拓扑的范围内泛洪自己的链路状态通告（LSA），每台路由器都会获得整个拓扑中其它所有路由器的 LSA。
	- LSA存储 连接自己的所有边 及 边的代价
	- 边内容包含目的路由器ID和目的路由器IP
## 5.BGP 路由协议
- 边界发言人交换路径向量
### 四种报文
1. OPEN(打开)报文:用来与相邻的另一个BGP发言人建立关系，并认证发送方。
2. UPDATE(更新)报文:通告新路径或撤销原路径。
3. KEEPALIVE(保活)报文:在无UPDATE时，周期性证实邻站的连通性:也作为OPEN的确认。
4. NOTIFICATION(通知)报文:报告先前报文的差错:也被用于关闭连接。
# (六)IP组播
- **单播、广播、多播/组播**:
    - **单播**: 一对一通信。视频服务器给90个客户端发同一份视频要发90个请求
    - **多播**: 一对多通信，视频服务器给90个客户端发同一份视频只要发1个请求
- **组播协议**:
    - **IGMP协议**: 让路由器知道局域网内是否有主机参加或退出某个组播组。
    - **组播路由选择协议**: 寻找以源主机为根的组播转发树。
- **硬件组播**:
    - 组播MAC地址以 `01-00-5E` 开头，后6个十六进制位根据IP组播地址的最后23位转换得到。
    - 地址范围: `01-00-5E-00-00-00` 到 `01-00-5E-7F-FF-FF`。
- **IP组播地址**:
    - 范围: `224.0.0.0` 到 `239.255.255.255`，属于D类地址。
    - 用于UDP，尽最大努力交付数据。
    - 不产生ICMP差错报文。
    - 不是所有D类地址都可以用作组播地址。
# (七)移动IP
## 1. 移动IP的概念
- **目标**: 使移动结点（计算机、服务器等）在跨越不同网段时保持固定的网络IP地址，实现漫游功能，并保证网络权限不受影响。
- **移动结点**: 具有固定IP地址的设备，在不同网络之间移动。
- **归属代理/本地代理**: 初始或归属地的代理，用于管理移动结点的网络连接。
- **永久地址/归属地址/主地址**: 移动结点的固定IP地址。
- **外部代理/外地代理**: 移动结点所在的外部网络的代理。
- **转交地址/辅地址**: 用于外部网络中的地址，确保移动结点在不同网络间的连接。
## 2. 移动IP通信过程
#### 简单总结：发送接受都需要经过归属网络，让本地代理代完成
A使用移动IP，B在广域网中
1. **A刚进入外部网络**：
    - 在外部代理登记获得转交地址，离开时注销。
    - 外地代理向本地代理登记转交地址。
2. **B给A发送数据报**：
    - 本地代理截获数据报（当主机A不在时）。
    - 本地代理封装数据报，将目的地址修改为转交地址，并通过隧道发送给外部代理。
3. **A给B发送数据报**：
    - A使用自己的主地址作为源地址，B的IP地址作为目的地址发送数据报。
4. **A移动到下一个网络**：
    - 在新外部代理注册转交地址。
    - 新外部代理将新转交地址发送给本地代理，覆盖旧地址。
    - 数据通信继续。
5. **A回到归属网络**：
    - A向本地代理注销转交地址。
    - 恢复原始通信方式。
# (八 )网络层设备
## 1. 路由器的组成和功能
- **路由器**: 是具有多个输入端口和输出端口的专用计算机，主要用于不同网络之间的连接与数据转发。
- **输入/输出队列溢出**: 路由器在转发数据时，输入或输出队列的溢出是导致分组丢失的一个重要原因。
## 2. 路由表与分组转发
- **路由表**: 通过路由选择算法生成，软件实现，用于决定数据包的转发路径。
- **转发表**: 由路由表得来，可以通过软件或硬件实现。转发表的每一行包含目的网络到输出端口及相关MAC地址的映射。
## 三层设备区别
- **路由器**: 可以互联不同网络层协议的网段（例如，IP协议间的互联）。
- **网桥/交换机**: 可以互联不同物理层和链路层的网段（例如，连接不同局域网）。
- **集线器**: 只能在同一物理层的网段内工作，无法互联不同的物理层网段。
