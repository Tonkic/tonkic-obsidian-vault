---
tags:
  - 操作系统
---
# 文件
## 1.文件的基本概念
文件包括文件的属性和操作：  
- 属性（也叫文件==元数据==）包括：名称，标识符，类型，位置，尺寸，权限，创建和修改时间，文件的所有者和使用者等等。  
- 文件的操作包括：创建文件，读文件，写文件，重新定位文件的读写位置，删除文件和截断文件。
FCB文件控制块（目录项）
- 名称，类型，位置（路径），逻辑结构，物理结构，尺寸，权限，创建和修改时间，文件的所有者和使用者，==物理位置==
## 2.文件元数据和索引节点(inode)
*使用inode改造FCB后，将除==文件名称/路径/子目录文件列表==外的其他信息放到inode，并把==物理位置==改成==inode号==，通过inode号去inode表找inode（类似数组下标）*
## 3.文件的操作
1. **文件创建** (`create` 系统调用)  
    用于在文件系统中创建新文件。
2. **文件删除** (`delete` 系统调用)  
    从文件系统中删除指定文件，释放其占用的资源。
3. **文件读取** (`read` 系统调用)  
    从打开的文件中读取数据到内存。
4. **文件写入** (`write` 系统调用)  
    将数据写入到打开的文件。
5. **文件打开** (`open` 系统调用)
    - 使用文件路径和名称，返回文件描述符（fd）作为文件在内存“打开文件表”的序号。
    - 打开文件表的内容：
		1. **文件描述符（fd）**：文件的唯一标识符。
		2. **指向 inode 的指针**：指向文件的 inode 结构体，其中包含文件的元数据，如权限、大小和位置等。
		3. **文件指针（文件偏移量）**：记录当前的读写位置。每次读或写操作都会更新这个指针。
		4. **文件状态标志**：指示文件的状态，例如只读、可写、已关闭等。
		5. **引用计数**：表示有多少进程正在使用该文件，以便在没有进程使用时可以释放资源。
6. **文件关闭** (`close` 系统调用)  
	关闭已打开的文件，使打开计数器-1，如果计数器为0则释放资源。
## 4.文件的保护
1. **口令保护**：
    - 在文件的 FCB（文件控制块）或索引节点中存储口令。
    - 用户打开文件时需输入口令。
    - 优点：实现简单。
    - 缺点：保密性较弱。
2. **加密保护**：
    - 使用异或加密技术：原始文件与密码进行异或操作，存储异或后的数据。读取时再次与密码异或进行解密。
    - 优点：保密性强。
    - 缺点：加密和解密过程消耗时间。
3. **访问控制**：
    - 在文件的 FCB 或索引节点中增加访问控制列表（ACL），记录不同用户对文件的操作权限。
    - 访问控制列表可能很大，尤其是在用户数量多的情况下。
    - 精简访问控制表：将用户分为几个组（如系统管理员、文件主、文件主的伙伴、其他用户），类似于 Linux 系统的用户分组。
    - 权限可以精细化，通常表现为一组 rwx 权限。
    - 也可以将访问控制抽象为矩阵存储，其中行代表用户，列代表权限，矩阵中元素数量与权限个数相同。
## 5.文件的逻辑结构
1. **无结构文件 / 流式文件**：
    - 文件内部数据是二进制流或字符流，如 `.txt` 文件。
    - 数据没有明确的记录结构。
2. **有结构文件 / 记录式文件**：
    - 由若干相似的记录组成，每条记录有多个数据项。
    - 如数据表文件。
    - **顺序文件**：
        - 记录按顺序排列，可以是定长或可变长。
        - **存储方式**：
        - **链式存储**：记录串联，无法随机存取，只能顺序查找。
        - **顺序存储**：
            - 定长记录：可随机读取。
            - 可变长记录：不能随机存储，需要顺序查找。
        - 若使用顺序结构，可通过折半查找提高查询效率。
    - **索引文件**：
        - 使用定长记录（类似数组）替代变长记录。
        - 包含逻辑文件和逻辑表，映射到实际文件。
        - 适用于要求高实时性的场景。
        - 解决了顺序文件在增/删记录时的不便，同时支持随机存取，但索引表可能占用大量空间。
    - **索引顺序文件**：
        - 记录分组，每组有一个索引项。
        - 适用于记录较多时，可建立多级索引表。
    - **直接文件 / 散列文件（Hash File）**：
        - 使用哈希键直接确定物理存储地址，支持快速访问。
## 6.文件的物理结构
1. **非空闲磁盘块管理**：
    - **连续分配**：
        - 每个文件占用一组连续的磁盘块。
        - **优点**：顺序和随机访问效率高，读写速度快。
        - **缺点**：不便扩展，磁盘碎片多。
    - **链接分配**：
        - 文件块分配不连续，块通过链表链接。
        - **隐式链接**：每块存指向下一块的指针，查找效率低，但便于扩展。
        - **显式链接**：通过文件分配表（FAT）存储指针，支持随机访问，但FAT占用内存。
        - 一个磁盘一个FAT，FAT表中的一个条目 记录 “没有下一个块”（-1或EOF） 或 指向下一个簇的地址。FAT32表示使用32位的簇指针
    - **索引分配**：
        - 每个文件有一个索引表，映射==逻辑块号到物理块号==。
        - **优点**：易于扩展。
        - **缺点**：索引表占用磁盘空间，可能需要多层索引或链接方案，导致效率低下。
        - 当磁盘块无法容纳整个索引表时，通常采用**链接方案**和**多层索引**来解决。
			##### 链接方案
			- **原理**：多个索引块通过指针链接在一起，形成链表。在第一个索引块中，会存放指向下一个索引块的指针。
			- **缺点**：当文件非常大时，需要顺序读取前面的索引块，导致访问效率低。
			##### 多层索引
			- **原理**：通过多层索引表来组织文件的索引。例如，第一层索引块存放第二层索引块的位置，形成多级地址映射。
			- **例子**：使用两层索引时，文件最大支持64MB（256×256×1KB）。
			- **缺点**：需要多次磁盘IO来访问每一层索引。
			##### 混合索引
			- **原理**：结合直接索引、一级索引和二级索引，使得文件的索引表同时包含多种类型的索引，优化文件访问效率。
1. **空闲磁盘块的管理**：
    - **存储空间划分**：将磁盘划分为文件卷（逻辑盘），包含目录区和文件区。
    - **几种管理方法**：
        - **空闲表法**：记录空闲起始块号和空闲的盘块数。
        - **空闲链表法**：通过链表管理空闲盘块或盘区。
        - **位示图法**：使用二进制位表示每个盘块的状态，1：已分配  
		0：未分配，然后在矩阵中索引块号
        - **成组链接法**：超级块记录空闲盘块的链头和长度，每个文件一个链表
# 目录
## 1.目录的基本概念
### FCB
### 文件目录结构总结
1. **单级目录**
    - 早期系统采用，整个系统只有一个目录，文件名不能重复。
2. **两级目录**
    - 包括主文件目录（存用户）和用户文件目录（每个用户的文件），用户文件被组织在用户目录下。
3. **多级目录（树形目录）**
    - 树形结构，便于分类和管理文件，更有效的保护文件，但不利于文件共享。
4. **无环图目录结构**
    - 基于树形目录，增加有向边来实现文件共享。多个文件名可以指向同一文件或目录。通过共享计数器管理共享结点，只有当计数器为0时才删除结点。
## 2.树形目录
## 3.目录的操作
新建删除查找等，删除需要把目录下所有子目录和子文件删除
## 4.硬链接和软链接
1. 1. **硬链接**
    - 硬链接通过索引节点连接多个文件名，每个文件名指向相同的inode，多个文件名指向同一数据块。
    - 文件的链接计数（`count`）在inode中，表示有多少个文件名指向该inode。
    - 删除任一硬链接不会删除文件内容，只有最后一个链接被删除时，文件数据和inode才会被释放。
2. **软链接**
    - 软链接可以理解一个特殊文本文件，包含指向目标文件路径的文本信息，类似快捷方式。
    - 软链接和源文件的inode不同，它只包含指向源文件的路径的信息。
    - 删除源文件后，软链接会失效，但软链接文件依然存在。
    - 软链接的创建会新建一个计数为1的inode，对源文件inode不影响
# 文件系统
## 1.文件系统的全局结构(layout)
## 文件系统在外存中的结构
- **主引导记录（MBR）**  
    存储活动分区信息，引导块用于启动操作系统。
- **引导块**  
    用于启动操作系统，位于分区的起始位置。
- **超级块**  
    包含分区的块数、大小，以及空闲块的指针和数量。
- **位示图/指针**  
    管理inode，记录哪些块是空闲的，哪些是已分配的。
## 2. 文件系统在内存中的结构
- **安装表（Mount Table）**  
    记录挂载的分区信息。
- **目录结构的缓存**  
    缓存目录信息，加快访问速度。
- **系统打开文件表**  
    管理系统范围内打开的文件。
- **进程打开文件表**  
    管理每个进程打开的文件。
## 3. 文件系统的全局结构
1. **初始化**
    - **物理格式化**：
        - **分扇区**：划分扇区，检测坏扇区、为每个扇区使用特殊数据结构，包括检验码
	- **分区**：
		- 第一步：将磁盘划分为多个逻辑部分（如C盘、D盘），信息记录在MBR的第二个磁盘块中。
	    - 第二步：逻辑格式化：
	        - **创建文件系统**：如FAT或Unix的索引节点表。
	        - **根目录**：创建文件系统的基础目录。
	        - **确定簇大小**：设置文件分配单元的大小。
2. **引导操作系统**
    - 格式化完成后，通过引导块启动操作系统。
## 2.外存空闲空间管理方法
## 3.虚拟文件系统
- 进程直接访问虚拟文件系统，不用关心文件系统的实现（可能由几个不同的文件系统 统一接口 连接到虚拟文件系统）
- 特性
    - 统一接口
    - 使用vnode统一数据结构（inode实际的->vnode虚拟的）
    - vnode中有函数功能指针指向实际文件系统的功能函数（read/write）
## 4.文件系统挂载(mounting)
**挂载Mounting**是将存储设备的文件系统连接到操作系统的目录结构中，比如U盘连接电脑时可以通过文件目录访问
1. **挂载过程**：操作系统将存储设备（如硬盘、U盘、CD-ROM等）挂载到文件系统树的某个目录上（称为挂载点）。通过该挂载点，用户可以访问存储设备上的文件。
2. **卸载**：当计算机关机时，系统会卸载所有已挂载的存储设备并写入未写入的数据，确保数据完整性和文件系统结构的正确性。
3. **注意事项**：挂载点应选择空目录，避免覆盖系统关键目录。挂载时，原目录中的文件会被隐藏，挂载点下的文件来自挂载的设备。
4. **命令**：在Linux中，`mount`命令用来挂载文件系统，`umount`命令用来卸载文件系统。