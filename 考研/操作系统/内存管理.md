---
tags:
  - 操作系统
---
# 内存管理基础
## 1.内存管理的基本概念
### 逻辑地址空间与物理地址空间
不同进程可有相同的逻辑地址，因为逻辑地址可以映射到不同的物理内存位置
### 地址变换
- 会在系统中设置一个 页表寄存器(PTR)，存放 页表在内存中的起始地址F和页表长度M,
- 通过M来判断页号是否>=页表项数量，大于等于的时候触发越界中断，因为页表从0开始
- 进程未执行时，页表的始址 和 页表长度放在进程控制块(PCB)中，当进程被调度时，操作系统内核才会把他们放在页表寄存器中。
 ![../../pic/Pasted image 20241210164507 1.png](../../pic/Pasted%20image%2020241210164507%201.png)
### 内存共享
两个不同的虚拟地址通过页表映射到物理空间的同一区域，它们所指向的这块区域即共享内存
### 内存保护
- 保证各进程在各自存储空间内运行，互不干扰
    - 操作系统的任务，处于安全性和效率，必须有硬件实现。
    - 两种方式
        - 设置上下限寄存器
        - 利用重定位寄存器、界地址寄存器进行判断
### 内存分配与回收
#### 连续分配管理方式
- 单一连续分配
- 固定分区分配
- 动态分区分配
#### 非连续分配管理方式
- 分页
- 分段
- 段页式
## 2.连续分配管理方式
### 单一连续分配
- 只支持单道程序，内存分为系统区和用户区，用户程序放在用户区，同一时刻只有一道用户程序
### 固定分区分配
- 将整个用户空间划分为若干个固定大小的分区
### 动态分区分配
#### 如何记录空闲内存
##### **空闲分区表**
- 每个空闲分区都对应一个表项，包含分区号、分区大小、分区起始地址等信息。
##### **空闲分区链**
- 每个分区的起始部分和末尾部分设置前向指针和后向指针，起始部分还可以记录分区的大小等信息，形成双向链表。
##### 基于顺序搜索的分区分配
- 首次适应算法（First FIt）
	- 每次都从低地址开始查找，找到第一个能满足大小的空闲分区
- 最佳适应算法（Best Fit）
	- 空闲分区按容量递增次序链接，优先使用更小的空闲区
	- 会产生很多很小的，难以利用的内存快，会产生很多的外部碎片
- 最坏适应算法(Worst Fit)\ 最大适应算法(Largest Fit)
	- 优先使用更大的空闲区，减少小外部碎片的产生
	- 大进程无内存可用
- 临近适应算法（Next Fit）
	- 首次适应算法的改进，从上次查找结束的位置开始检索，以减低前面算法每次都从最前面开始查找的开销
##### 基于索引搜索的分区分配
- 快速适应算法（分类搜索法）
![../../pic/Pasted image 20241210170401 1.png](../../pic/Pasted%20image%2020241210170401%201.png)
- 伙伴系统
	- 无论已分配分区或空闲分区，其大小均为 2 的 k 次幂(k 为整数，1 ≤ k ≤ m)。将这些空闲分区按分区的大小进行分类，对于具有相同大小的所有空闲分区，单独设立一个空闲分区双向链表。
	- 从小到大找适合的空间(2^i-1 < n ≤ 2^i)，找得到就用，*找不到就把上一级的拆成两块*，自己用一块，另一块空闲
![../../pic/Pasted image 20241210170507 1.png](../../pic/Pasted%20image%2020241210170507%201.png)
- Hash 算法
	- 在可利用空闲区表中建立哈希函数
## 3.页式管理
1. **分页存储**
    - **物理上**：内存被划分为大小相等的页框。
    - **逻辑上**：进程的地址空间被分为相同大小的页面。
2. **页表**
    - 进程与内存的对应表。每个页表项指示一个页面在物理内存中的位置(虚页号指向页框号)
    - 页号是隐含的，不占空间
3. **地址转换**
    - **页号**：逻辑地址除以页面大小。
    - **页内偏移量**：逻辑地址对页面大小取模。
    - 对于2的幂次方大小的页面，页号由高位决定，页内偏移量由低位决定。
4. **基本地址变换机构** 
  - [内存管理 \> 地址变换](#地址变换)
5. **块表地址变换机构**
	- 快表需要存页号用来标识
![../../pic/Pasted image 20241210171121 1.png](../../pic/Pasted%20image%2020241210171121%201.png)
6. **两级页表**
    - 逻辑地址变为一级页号+二级页号+页内偏移量
7. **虚拟存储技术与缺页中断**
    - 页表项增加标志位，指示页面是否在内存中。如果页面不在内存中，会发生缺页中断并加载页面。
8. **多级页表**
    - 多级页表机制可解决页表过大和内存不连续的问题，保证每级页表的大小不超过一个页面。
## 4.段式管理
![../../pic/Pasted image 20241210171544 1.png](../../pic/Pasted%20image%2020241210171544%201.png)
## 5.段页式管理
先分段，段内分页
逻辑地址段号+页号+页内偏移量
# 虚拟内存管理
## 1.虚拟内存的基本概念
- 基于局部性原理，将程序常用部分加载到内存，其他部分存储在外存。
- **最大容量**
    - 由CPU地址长度决定。若CPU字长能表示的内存大于外存，虚拟内存容量为内存与外存之和。若外存容量远大于CPU字长，虚拟内存容量受CPU字长限制。
## 2.请求页式管理
- 页表除了记录页面的物理地址外，还增加了以下四个字段：
    - **状态位**：表示该页面是否已调入内存，未调入时会触发缺页中断。
    - **访问字段**：记录页面的访问情况，可以用于置换算法选择哪些页面需要被换出。
    - **修改位**：表示页面是否被修改，若未修改则不需要写回外存。
    - **外存地址**：表示页面在外存中的存放位置。
## 3.页框分配与回收
1. **驻留集**：进程分配的物理块集合，大小通常小于进程总大小。
    - **过小**：频繁缺页，性能下降。
    - **过大**：（整个系统）多道程序并发度降低，资源利用率下降。
2. **页面分配与置换策略**：
    - **分配方式**：
        - **固定分配**：驻留集大小不变。
        - **可变分配**：驻留集大小可动态变化，根据需要调整。
    - **置换方式**：
        - **局部置换**：仅替换进程自己的页面。
        - **全局置换**：可替换其他进程的页面或空闲物理块。
	- 固定分配不能搭配全局替换
3. **调入页面的时机**：
    - **预调页策略**：运行前预测可能访问的页面，成功率低。
    - **请求调页策略**：运行时缺页触发调入，单次调入一页，IO开销较大。
4. **页面调入来源**：
   对换区：外存中速度较快的区域，用于与内存交换数据，连续分配
   文件区：外存中速度较慢的区域，离散分配（页式/段式）
    - **对换区足够**：页面在内存与对换区间调入调出。
    - **对换区不足**：未修改页面直接从文件区调入，修改页面需写回对换区。
    - **UNIX方式**：未使用页面从文件区调入，使用后换出写回对换区。
6. **抖动现象**：  
    页面频繁被换入换出，导致性能严重下降。通常是进程频繁访问的页面数目超出可用物理块数。
7. **工作集**：  
    进程在一段时间内实际访问的页面集合。驻留集大小应大于或等于工作集大小，以避免频繁缺页。
## 4.页置换算法
- **最佳置换算法（OPT）**：选择未来最久不被使用的页面，但此算法无法实现。
- **先进先出算法（FIFO）**：淘汰最早进入内存的页面，但可能导致**Belady异常**，缺页率反而增大。
- **最近最久未使用算法（LRU）**：淘汰最久未使用的页面，通常根据访问字段进行选择。
- **时钟置换算法**：
	- 设置访问位，并将内存页面链接成循环队列。当页面被访问时，访问位设为1。
	- 淘汰页面时，检查页面的访问位：若为0，则换出该页；若为1，将访问位设为0，跳过该页，继续检查下一个页面。
- **改进型时钟算法**：优先淘汰未修改的页面，减少写回外存的IO开销。
## 5.内存映射文件(memory-mapped files)
传统只能顺序读文件，使用内存映射文件后可以随机读写文件
- **优点**：
    - 可以像访问普通内存那样访问文件数据，通过指针直接读写文件，而不是调用传统的文件I/O操作
    - 提高处理大型文件时的性能，特别是需要频繁随机访问文件部分内容的场景
- **传统访问方式**：
    1. `open`：打开文件。
    2. `seek`：移动读写指针。
    3. `read`：从当前位置读取数据，磁盘到内存。
    4. `write`：将内存数据写回磁盘，位置由读写指针确定。
- **内存映射文件访问方式**：
    1. `open`：打开文件。
    2. `mmap`：将文件映射到进程的虚拟地址空间（映射后文件内容在内存中，初始为缺页状态）。
## 6.虚拟存储器性能的影响因素及改进方法
缺页率，页大小，工作集和驻留集大小等