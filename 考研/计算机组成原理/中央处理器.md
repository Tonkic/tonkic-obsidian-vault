---
tags:
  - 计算机组成原理
aliases: []
---
# CPU的功能和基本结构
ALU+寄存器+PSW [数据的表示和运算 \> \*\*标志位的生成\*\*](数据的表示和运算.md#**标志位的生成**)+移位器+计数器
# 指令执行过程
## 指令周期
取指+执行一条指令所用的时间
包含多个机器周期
## 指令流程
### 取指周期   
将PC中的值送到MAR作为访存地址，访存得到的指令内容存在MDR，然后将MDR的内容送到指令寄存器IR，PC自增（+1）
这里送的动作通过CPU总线实现
### 间指周期（可选）
第一次访存得到指令的地址，第二次访存才得到指令，则第一次是间址周期
### 执行周期   
根据操作码执行
### 中断周期（可选）
# 数据通路的功能和基本结构
## 定义
- 数据在功能部件之间传送的路径
## 组成
### 组合逻辑元件（操作元件）
- 输入决定输出
- 不含存储信号的记忆单元
- 如译码器，多路选择器，三态门
### 时序逻辑元件（状态元件）
- 与此刻的输入和此前的输入都有关
- 必须有存储信号的记忆单元
- 如通用寄存器组，PC，锁存器
### 寄存器与ALU之间的数据传送(执行算数或逻辑运算)
一个暂存寄存器直连ALU，一个ACC累加器寄存器通过总线连接ALU，两个同时通向ALU实现加法
# 控制器的功能和工作原理
## 工作原理
- CU 发出一个 微命令，可完成对应 微操作。
## 设计
### 硬布线
- 根据指令操作码、目前的机器周期、节拍信号、机器状态条件、即可确定当前状态应该发出哪些 “微命令”
- 比如遇到执行周期的ADD和LDA(读取数据到ACC)就执行M(MAR)->MDR
### 微程序
#### 概念
- 程序：指令序列
- 微程序：微指令的有序集合
	- 采用“存储程序”的思想，CPU出厂前所有指令的“微程序”存入“控制器存储器”中
	- 存放微程序的地址是微地址        
- 微指令：包含微操作码 和 微地址码
- 微周期：从控制器存储器取出一条微指令并执行相应微操作所需的时间
- 微命令：收到微命令执行微操作，微命令与微操作一一对应
#### 执行过程
1. 将指令的操作码送到微地址形成部件
2. 得到初始微地址和微程序长度，初始微地址存入μPC（CMAR）
3. 通过地址译码，去控制器存储器CM找到微指令，然后存入，μIR（CMDR）
4. 通过微指令的下地址（类似指令地址码）找到下条微指令地址
#### 微指令的格式
##### 水平型微指令
- 一条微指令可以定义多个 可并行的微命令（微操作）
##### 垂直型微指令
- 一条指令只能定义一个微命令（微操作）
#### 微指令的编码方式（重要）
##### - 直接编码、直接控制
- 微指令的操作控制字段中，每一位代表一个微操作命令
- 1001 1001八位对应执行1，4，5，8位对应的操作，8位只能对应8种操作
##### - 字段直接编码方式
- 将微指令的控制字段分成若干 ‘段“，每段经译码后发出控制信号。
- 译码使得4位对应15种操作（减去一种空操作）
###### 分段原则
- *互斥性微命令在同一段内 相容性微命令在不同段内*
- 每个小段信息为不能太多
- *每个小段留出一个状态(一般是全0)，表示本字段不发出任何微操作*
##### - 字段间接编码方式、间接编码、隐式编码
- 一个字段的某些微命令需由另一个字段中的某些微命令来解释
#### 微指令的地址形成方式
- 微指令的 下地址字段 指出。（分支转移）
- 增量计数器法 (μPC)+1->μPC
- 第一条微指令地址，由微地址形成部件（硬件）产生
- 中断周期，由 硬件 产生中断周期微程序首地址
# 异常和中断机制
## 1.异常和中断的基本概念
### 中断向量
中断服务程序的入口地址。
### 中断向量表
把系统中所有的中断类型码及其对应的中断向量按一定的规律存放在一个区域内，这个存储区域就叫做中断向量表。
### 中断源
1. 软中断/内中断。 
2. 外中断/硬件中断 
3. 异常
### 中断屏蔽字
- 1代表屏蔽，0代表响应
- 如四个中断中，一号中断屏蔽字1101代表不屏蔽第三个中断，即第三个中断优先级大于第一个中断
### 硬中断和软中断
- 硬中断是硬件引起的，如键盘
	- **终止异常**和**外中断**
- 软中断是软件引起的，如缺页
	- **故障异常**和**自陷异常**
## 2.异常和中断的分类
### 异常
#### 故障
缺页，除零
#### 自陷
- 预先安排的异常（例如断点）
- 返回之后从下条指令开始
#### 终止
使计算机无法继续执行的硬件故障，如控制器出错、存储器校验错等
### 中断
- 可屏蔽中断
- 不可屏蔽中断
## 3.异常和中断的检测与响应
1. **软件识别方式**：
    - CPU设置异常状态寄存器记录异常原因。
    - 操作系统通过统一查询程序按优先级顺序查询异常状态寄存器，检测异常和中断类型，先查询到的先处理，随后跳转至内核处理程序。
2. **硬件识别（向量中断）**：
    - 异常或中断处理程序的首地址称为中断向量，存储在中断向量表中。
    - 每个中断或异常都分配一个中断类型号，类型号对应中断向量表中的条目，类似数组下标。
# 指令流水线
## 1.指令流水线的基本概念
- 流水线的性能指标
    - 吞吐率、TP
        - 单位时间内流水线所完成的任务数量
    - 加速比、S
        - 完成同样一批任务，不使用流水线所用的时间 与 使用流水线所用的时间 之比。
    - 效率、E
        - 设备的利用率
            - 红框除以蓝框![Pasted image 20241208202825.png](../../pic/Pasted%20image%2020241208202825%201.png)
## 2.指令流水线的基本实现
### 五个阶段（MIPS架构）
- IF Fetch取指    
- ID Decode译码、取数
- EX EXecute执行
- M Memory访存
- WB Writeback写回寄存器
### 锁存器
- 流水线的每一个功能段部件后面都要有一个缓存寄存器/锁存器。
- 保存本流水段的执行结果，提供给下一流水段使用
## 3.结构冒险、数据冒险和控制冒险的处理
### **结构冒险（Structural Hazard）**  
指两条指令在不同阶段争用相同硬件资源（如内存）。解决方法包括：
- 后一条指令暂停一周期
- 数据重复配置，使用分离型cache，一个数据cache一个指令cache
- 多端口寄存器，寄存器读写口分开，可同时读
- 功能划分原则：每个部件每条指令只能在特定时钟周期使用一次
### **数据冒险（Data Hazard）**  
指后一条指令依赖前一条指令的结果，但前一条指令结果尚未产生。解决方法包括：
- 暂停若干时钟周期（硬件阻塞或软件插入NOP）
- 在load-use问题中，不能使用转发技术，只能插入流水线气泡
- 使用寄存器直通（转发机制）将最新计算结果直接传给下一条指令的ALU输入端
- 编译优化：通过调整指令顺序解决数据相关问题
### **控制冒险（Control Hazard）**  
发生在分支指令中，解决方法包括：
- 转移指令分支预测：简单预测（永远猜条件满足或不满足）、动态预测（根据历史推测）
- 预先把分支指令的两种可能都取出来
- 提前形成条件码（if判断的true/false），提高预测准确性
- 分支预测失败时，需要恢复寄存器状态到分支指令执行时
## 4.超标量和动态流水线的基本概念
### 超标量技术
- 每个时钟周期内可 并发多条独立指令
### 动态流水线
由**硬件**自动对指令的执行次序进行调度，==前面指令的阻塞不影响后面指令的继续前进。==
- 动态指令调度：指令在执行时根据实际情况调整执行顺序。
- 支持乱序执行：处理器可以不按程序顺序执行指令。
- 可以进行动态分支预测和指令重排，以减少冒险和延迟。
# 多处理器基本概念
## 1.SISD、SIMD、MIMD、向量处理器的基本概念
**SISD (单指令流单数据流)**
- 只能并发执行指令，不能并行。
- 每条指令处理一个数据。
- 硬件：一个处理器 + 一个主存储器。
- 可通过指令流水线增加功能部件和多模块交叉存储器。
**SIMD (单指令流多数据流)**
- 各指令并发执行，每条指令处理多个数据。
- 数据级并行技术。
- 硬件：一个CU + 多个执行单元 (如ALU) + 多个局部存储器 + 一个主存储器。
- 例如，优化for循环。
**MISD (多指令流单数据流)**
- 多个CPU执行多条指令并行处理同一数据。
- 现实中不存在这种计算机。（读写冲突）
**MIMD (多指令流多数据流)**
- 各指令并行执行，处理不同数据。
- 线程级或更高级的并行技术。
- 分成多处理器系统和多计算机系统
## 2.硬件多线程的基本概念
在处理器中同时管理多个线程状态，当线程发生切换时，处理器瞬间切换到对应的线程状态执行
### **分类**
1. 粗粒度
- 处理器在发现一个线程被长时间中断（如Cache miss）时，切换到其他线程执行。
1. 细粒度
- *每个时钟周期*都切换一次线程
2. 同时多线程（SMT）（指令级并行，上面两个只有线程级并行）
- 在超标量处理器中，同时发射多个线程的指令，多个线程的指令并行执行。
## 3.多核(multi-core)处理器的基本概念
一条总线上挂载多个处理器
共享cache和存储和总线，需要使用锁来限制读写
- **UMA**：所有处理器共享统一的内存访问，访问速度均等，适用于小规模系统。
- **NUMA**：每个处理器有自己的本地内存，访问自己内存快速，访问其他处理器内存有延迟，适用于大规模系统。
## 4.共享内存多处理器(SMP)的基本概念
1. **多处理器协同工作**
2. **共享资源**：处理器共享同一个内存、I/O接口和外部中断
3. **对称性**：所有处理器对内存和系统资源的访问权限是平等的
4. **并行计算能力**：由于多个处理器可以同时执行多个任务，适合多任务和并行计算需求。
5. SMP属于UMA