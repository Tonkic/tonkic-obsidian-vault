---
tags:
  - 计算机组成原理
---
# 总线
## 1.总线的基本概念
- 能为多个部件分时共享的公共信息传送线路
- 分为共享总线和分时总线
## 2.总线的组成及性能指标
### 总线的组成及性能指标总结
#### **总线的组成：**
**片内总线**：
- 用于芯片内部不同部件之间的连接，如CPU内部寄存器、ALU之间的连接。
**系统总线**：
- 连接计算机系统各部件（如CPU、主存、I/O接口）之间。
- 包括：
	- **数据总线**：传输数据。
	- **地址总线**：传输地址信息。
	- **控制总线**：传输控制信号。
**总线结构**：
- **单总线结构**：所有设备连接到同一总线。
- **双总线结构**：通过通道管理慢速I/O设备，一条总线连cpu主存通道，通道和外存一条总线
- **三总线结构**：CPU通过IO总线连接io接口，通过主存总线连接主存，通过DMA总线连接主存和IO接口
- **四总线结构**：通过桥接器连接不同总线，具有缓冲、转换和控制功能。
#### **总线的性能指标：**
1. **总线的传输周期**：
	- 一次总线操作所需的时间，包括申请、寻址、传输和结束阶段。
2. **总线时钟周期**：
	- 机器的时钟周期，控制整个计算机及总线操作。
3. **总线的工作频率**：
	- 总线操作的频率，通常是总线周期的倒数。
4. **总线的时钟频率**：
	- 机器时钟频率，表示每秒钟有多少个时钟周期。
5. **总线宽度**：
	- 总线一次能传输的数据位数，通常表示为位数（如32位总线）。
6. **总线带宽**：
	- 单位时间内总线能传输的数据量。计算公式为：
	- 总线带宽 = 总线工作频率 × 总线宽度（bit/s）
	- 或者 总线带宽 = 总线工作频率 ×（总线宽度/8）(B/s)
## 3.总线事务和定时
1. **总线事务的四个阶段**：
    - **申请分配阶段**：设备发出请求，仲裁决定哪个设备使用总线。
    - **寻址阶段**：主设备通过总线发送从设备地址和命令，启动从设备。
    - **传输阶段**：主从设备进行数据交换。
    - **结束阶段**：释放总线使用权。
2. **总线定时**：
    - 设备间为了协调数据交换的时间制定的协议。
	- 分类：
		- **同步通信**：统一时钟协调，适用于总线短且设备存取时间接近的系统，但可靠性差。
		- **异步通信**：无统一时钟，通过“握手”信号进行控制，分为：
			- **不互锁**：发送后不必等应答。
			- **半互锁**：发送信号等待应答后撤销。
			- **全互锁**：发送信号等应答才能撤销。
		- **半同步通信**：结合同步和异步，使用统一时钟并增加“等待”信号。
		- **分离式通信**：不使用总线的那段时间，放弃占用总线 从设备准备好后，在申请占用总线，传输数据
# I/0接口(I/0控制器)
## 1.I/0 接口的功能和基本结构
### I/0 接口的功能
- 数据缓存
	- 通过数据缓冲寄存器DBR，达到主机和外设工作速度的匹配    
- 错误或状态检测
	- 通过状态寄存器反馈设备的各种错误、状态信息、供CPU查用    
- 控制和定时
	- 接收从控制总线发来的控制信号、时钟信号
- 数据格式转换
	- 外设与主机的数据格式不一致，比如串行转并行
- 与主机和设备通信
	- 主机和外设的时序控制
- 地址译码
	- 译码之后在多个外设中选择正确的外设
### 基本结构
数据寄存器，状态/控制寄存器，io控制逻辑
![[Pasted image 20241208221252.png]]
## 2.I/O 端口及其编址
1. **统一编制（存储器映射方式）**：
    - 主存和I/O控制器共享地址空间，使用同一套地址码。
    - 通过不同的地址码区分主存和I/O端口，访存类指令可以访问两者。
    - 常见于RISC（精简指令集机器）架构。
2. **独立编制（I/O映射方式）**：
    - 主存和I/O控制器使用独立的地址空间。
    - 通过不同的指令格式区分内存和I/O设备。
    - 只能通过专用I/O指令访问I/O端口。
# I/0方式
## 1.程序查询方式
cpu轮询检查
- 独立查询 - CPU一直查询接口
- 定时查询 - 周期性查询
## 2.程序中断方式
### 中断的基本概念
中断请求，中断判优，中断响应，中断服务和中断返回五阶段
### 中断响应过程
使用中断隐指令，由硬件实现的
（1）某一中断源向CPU发起*中断请求*
- 内部中断立刻响应，外部中断执行完再响应
（2）CPU响应中断后，将*状态标志寄存器*压入堆栈保护；
（3）再将其中的中断标志位清除从而*关闭中断*；
（4）CPU将当前CS（PC的基址寄存器）和PC（将要执行的下一条地址）压入堆栈*保存断点*；
（5）CPU确定提出请求的中断源，获得中断向量号，在对应的中断向量表获得中断入口地址, 装入CS和IP中；
### 中断处理过程
使用中断服务程序，由软件实现
（6）将断点处各寄存器的内容压入堆栈保护现场；
（7）此时程序跳转至中断服务子程序执行；
（8）中断处理完毕，将堆栈各寄存器内容弹栈，恢复断点处各寄存器的值；
（9）在中断服务子程序最后安排一条返回指令，执行该指令将堆栈中CS和IP的值弹出，恢复主程序断点处地址值，同时恢复标志寄存器的内容。程序转至被中断的程序继续执行。
### 多重中断和中断屏蔽的概念
1. **单重中断**：
    - 关中断一直到执行完中断服务程序
2. **多重中断（中断嵌套）**：
    - 执行中断服务程序前，先开中断，没有新中断再执行，允许中断嵌套。
中断屏蔽字[[中央处理器#中断屏蔽字]]
## 3.DMA 方式
### DMA 控制器的组成
![[Pasted image 20241208215947.png]]
### DMA 传送过程
例：数据缓冲寄存器32位，磁盘块512B，DMA每次传输一个块
1. **DMA请求**：
- 外设通过发送DMA请求将数据传送到数据缓冲寄存器（32位），并将传输长度寄存器值-1 初始值为128（512B/32b）。
2. **DMA控制器操作**：
- DMA控制器收到32B数据后向CPU发出*总线请求*，获得总线权限后将数据从缓冲寄存器传送到内存。
3. **传输完成与中断**：
- 当传输一块数据完成，如果传输长度寄存器减至0时，DMA控制器发出DMA*中断请求*通知CPU DMA过程已经完成
4. **总线冲突解决**：
- 当CPU和DMA都需要访问主存时，DMA优先：
	- **停止CPU访问主存**。
	- **交替访存**：CPU与DMA交替使用总线。
	- **周期挪用与窃取**：DMA优先访问，可能在CPU存取周期结束后访问主存。